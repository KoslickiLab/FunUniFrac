## KEGG KO Hierarchical Substree Extraction

Chunyu Ma (cqm5886@psu.edu)

Last update: 2023.2.21

#### **Data location (CPU server)**:

```
# output directory
output_dir=/data/shared_data/temp_chunyuma_process_kegg

# script directory
script_dir=../scripts 
```

#### **Description**
This document describes how to extract the KO hierarchical tree (e.g., [ko00001](https://www.genome.jp/brite/ko00001)) via both KEGG API and the clean KO data generated by Shaopeng Liu (using KEGG FTP data). I wrote a python script `generate_ko_hierarchy.py` to automatically pull the hierarchical tree via KEGG API, and then covert the tree to an edge list. This script allows the users to provide a list of [brite ids](https://rest.kegg.jp/list/brite) to query the tree via `--brite_list`, and also allows you to filter out some KOs in which you might not be interested via a parameter `--saved_kos`. To use this filtering function, you need to provide a list of KOs that you are intersted in.


#### **Use Cases**

1. pull the whole hierarchical tree based on given brite ID, covert it an edge list, and save the result to a specific location
```Shell
python ${script_dir}/generate_ko_hierarchy.py --brite_list "ko00001" --outdir ${output_dir}
```

 2. pull the whole hierarchical tree based on given brite ID, filter out non-microbe-assocaited KOs, covert it an edge list, and save the result to a specific location
* Downlaod organism table from KEGG API and find microbe-associated organism (e.g., 'Archaea', 'Bacteria') code via the following command lines:
```Shell
wget https://rest.kegg.jp/list/organism
for keyword in 'Archaea;' 'Bacteria;'; do grep $keyword organism;done | cut -f 2 > microbe_org.txt
rm organism
```
* Use python code below to find microbe-associated KOs
```Python
import pandas as pd

## use shaopeng's data
ko_file = '/data/shared_data/cleaned_KEGG_FTP_2022_NOV/ko_genes.list'

## read ko file
ko_gene_table = pd.read_csv(ko_file, sep='\t', header=None)
ko_gene_table.columns = ['KOID', 'gene']
ko_gene_table['KOID'] = ko_gene_table['KOID'].str.replace('ko:','')
ko_gene_table['org_code'] = ko_gene_table['gene'].str.split(':',expand=True)[0]

## read microbe
microbe_org = pd.read_csv('microbe_org.txt', sep='\t', header=None)

## get microbe KOs
microbe_KOs = list(ko_gene_table.loc[ko_gene_table['org_code'].isin(list(microbe_org[0])),'KOID'].value_counts().index)

## save microbe KOs
pd.DataFrame(microbe_KOs).to_csv('microbe_KOs.txt', sep='\t', index=None, header=None)
```
* Run script to generate a subtree based on a list of intrested KOs
```Shell
python ${script_dir}/generate_ko_hierarchy.py --brite_list "ko00001" --saved_kos ./microbe_KOs.txt --outdir ${output_dir}
```

#### Results
I saved the output files of above two cases into the directory `/data/shared_data/temp_chunyuma_process_kegg` on the CPU server. The file `kegg_ko_edge_df_ko00001.txt` contains 25,650 KO IDs while the file `kegg_ko_edge_df_filtered_ko00001.txt` contains KO IDs that are all microbe-assocaited KOs.